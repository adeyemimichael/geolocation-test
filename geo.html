<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .button-container {
            margin: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>

    <h2>Geolocation App</h2>
    <div id="map"></div>
    <div class="button-container">
        <button onclick="findNearbyPlaces('restaurant')">Find Restaurants üçΩÔ∏è</button>
        <button onclick="findNearbyPlaces('hospital')">Find Hospitals üè•</button>
        <button onclick="findNearbyPlaces('fuel')">Find Gas Stations ‚õΩ</button>
    </div>

    <script>
        let map = L.map('map').setView([6.5244, 3.3792], 13); // Default: Lagos, Nigeria

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let visitedLocations = [];

        function fetchWithTimeout(url, timeout = 10000) { // 10 sec timeout
            return Promise.race([
                fetch(url),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error("Request timed out")), timeout)
                )
            ]);
        }

        function getIcon(type) {
            const icons = {
                restaurant: 'https://cdn-icons-png.flaticon.com/128/1046/1046784.png',
                hospital: 'https://cdn-icons-png.flaticon.com/128/2966/2966484.png',
                fuel: 'https://cdn-icons-png.flaticon.com/128/3448/3448516.png'
            };
            return icons[type] || 'https://cdn-icons-png.flaticon.com/128/684/684908.png';
        }

        function findNearbyPlaces(type) {
            navigator.geolocation.getCurrentPosition(position => {
                let { latitude, longitude } = position.coords;
                map.setView([latitude, longitude], 14);
                
                let url = `https://overpass-api.de/api/interpreter?data=[out:json];node[amenity=${type}](around:5000,${latitude},${longitude});out;`;

                fetchWithTimeout(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (!data.elements || data.elements.length === 0) {
                            alert(`No ${type} found nearby.`);
                            return;
                        }

                        data.elements.forEach(element => {
                            if (element.lat && element.lon) {
                                let iconUrl = getIcon(type);
                                let icon = L.icon({
                                    iconUrl,
                                    iconSize: [30, 30]
                                });

                                L.marker([element.lat, element.lon], { icon })
                                    .addTo(map)
                                    .bindPopup(element.tags.name || `Unknown ${type}`);

                                visitedLocations.push({
                                    lat: element.lat,
                                    lon: element.lon,
                                    name: element.tags.name || `Unknown ${type}`
                                });
                            }
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching places:", error);
                        alert("Failed to fetch nearby places. Please check your internet connection.");
                    });

            }, error => {
                console.error("Geolocation error:", error);
                alert("Failed to get location. Please enable GPS.");
            });
        }
    </script>

</body>
</html>
